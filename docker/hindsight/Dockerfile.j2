FROM {{ namespace }}/base-tools:{{ tag }}
MAINTAINER {{ maintainer }}

# We use MOS packages for hindsight, lua_sandbox and lua_sandbox_extensions

ENV DEBIAN_FRONTEND noninteractive

COPY sources.mos.list /etc/apt/sources.list.d/
COPY mos.pref /etc/apt/preferences.d/

RUN apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 1FA22B08 \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
       hindsight \
       lua-sandbox-extensions \
    && cp /usr/share/luasandbox/sandboxes/heka/input/prune_input.lua \
          /usr/share/luasandbox/sandboxes/heka/input/heka_tcp.lua \
          /var/lib/hindsight/run/input/

ADD output/*.lua /var/lib/hindsight/run/output/
ADD input/*.lua /var/lib/hindsight/run/input/
ADD modules/*.lua /usr/lib/x86_64-linux-gnu/luasandbox/modules/stacklight/

RUN useradd --user-group hindsight \
    && usermod -a -G microservices hindsight \
    && chown -R hindsight: /var/lib/hindsight /etc/hindsight

USER hindsight
